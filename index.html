<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Consul4 by wangfakang</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Consul4</h1>
        <p class="header">some about registrator questions</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/consul4/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/consul4/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/wangfakang/consul4">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/wangfakang">wangfakang</a></p>


      </header>
      <section>
        <p><code>在使用Regastrator过程中遇到的问题：</code></p>

<h1>
<a id="首先简单介绍一下registrator是什么" class="anchor" href="#%E9%A6%96%E5%85%88%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8Bregistrator%E6%98%AF%E4%BB%80%E4%B9%88" aria-hidden="true"><span class="octicon octicon-link"></span></a>首先简单介绍一下Registrator是什么：</h1>

<pre><code>Registrator是一个可以监听通过docker启动服务，并且可以自动注册和注销该服务。并且目前支持
Consul, etcd and SkyDNS2相关服务注册组件。        
</code></pre>

<p>我在使用的过程中是使用的<code>cosnul</code>.         </p>

<h1>
<a id="实验过程中遇到的问题-" class="anchor" href="#%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98-" aria-hidden="true"><span class="octicon octicon-link"></span></a>实验过程中遇到的问题： </h1>

<ul>
<li><p>(1).当通过docker启动registrator 时， 给registrator的启动参数-internal=0（default）此时registrator注册
的服务的ip都是该registrator的容器的ip.    </p></li>
<li><p>(2).当通过docker启动registrator 时，给定docker指定网络参数--net=host,此时会注册到consul上服务的ip全部
都是127.0.1.1，原因是由于使用了host模式和本机使用相同的ip和port（处于同一个network空间）。            </p></li>
<li><p>(3).要想registrator注册到consul上的服务的ip是每一个服务容器的ip，则可以指定registrator的执行参数
-internal=1.此时注册到cosnul上的服务的ip就是每每一个服务容器的ip,注意并且此时注册服务的port也不再
是启动时给的映射port,而是其容器服务暴露的端口．</p></li>
<li><p>(4).如果我们想利用conusl+registrator+docker+consul_template来动态管理nginx则可以这样设计：
consul_templaye + regsitrator应该和要上线的服务打包到需要部署的机器上，而且此时使用--net=host
网络模式启动docker上的registrator，此时只需要启动服务的时候进行端口的映射就好了。         　　　　　　　　　　　　　 
方案二：当然也可以这样玩，给定registrator使用-internal=1,然后注意通过docker启动的服务一定要暴露相关
服务的端口．     </p></li>
<li><p>(5).当docker使用默认网络模式，则port是指定的映射端口。 映射端口和docker的网络模式是没有关系
的（registrator的网络模式）。但是当registrator使用了internal=1
的时候则此时所注册的服务的端口默认是80.当启动服务时-p 88:8000  则会在consul注册两个服务，
一个是80一个是8000.         </p></li>
</ul>

<h3>
<a id="上面的我场景的原因" class="anchor" href="#%E4%B8%8A%E9%9D%A2%E7%9A%84%E6%88%91%E5%9C%BA%E6%99%AF%E7%9A%84%E5%8E%9F%E5%9B%A0" aria-hidden="true"><span class="octicon octicon-link"></span></a>上面的我场景的原因:</h3>

<pre><code>有可能是在该dockerfile中没有暴露了端口（EXPOSE  80 ） 而且本身有一个服务是8000端口。而且初步猜测registrator会检测所有暴露的端口认为就是有可用的服务。
而且当使用-p  88:99是会出现88端口这个服务，看了下docker文档(建议看一下EXPOSE和-p以及-P他们之间的区别)，使用-p的时候会执行暴露端口以及做端口映射。
</code></pre>

<h3>
<a id="一句话来说就是" class="anchor" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9D%A5%E8%AF%B4%E5%B0%B1%E6%98%AF" aria-hidden="true"><span class="octicon octicon-link"></span></a>一句话来说就是：</h3>

<pre><code>所有发布了的端口（-p或-P）都会暴露，但是暴露了的端口（EXPOSE）不一定会发布。      
</code></pre>

<h1>
<a id="欢迎一起交流学习-" class="anchor" href="#%E6%AC%A2%E8%BF%8E%E4%B8%80%E8%B5%B7%E4%BA%A4%E6%B5%81%E5%AD%A6%E4%B9%A0-" aria-hidden="true"><span class="octicon octicon-link"></span></a>欢迎一起交流学习 </h1>

<p>在使用中有任何问题，欢迎反馈给我，可以用以下联系方式跟我交流</p>

<ul>
<li>邮件(1031379296#qq.com, 把#换成@)</li>
<li>QQ: 1031379296</li>
<li>weibo: <a href="http://weibo.com/u/2786211992/home">@王发康</a>
</li>
</ul>

<h1>
<a id="thx" class="anchor" href="#thx" aria-hidden="true"><span class="octicon octicon-link"></span></a>Thx</h1>

<ul>
<li>chunshengsterATgmail.com</li>
</ul>

<h1>
<a id="author" class="anchor" href="#author" aria-hidden="true"><span class="octicon octicon-link"></span></a>Author</h1>

<ul>
<li>Linux\nginx\golang\c\c++爱好者</li>
<li>欢迎一起交流  一起学习# </li>
<li>Others say good and Others good</li>
</ul>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("Registrator questions  consul service ip different");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
